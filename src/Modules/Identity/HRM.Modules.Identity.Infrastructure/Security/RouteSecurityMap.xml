<?xml version="1.0" encoding="UTF-8"?>
<RouteSecurityMap Module="Identity" Version="2.0" xmlns="http://hrm.system/route-security">
  <!--
    Identity Module Route Security Map
    Maps API routes to permissions

    This file is loaded at startup and used by RoutePermissionMiddleware
    to automatically protect routes without [Authorize] attributes.

    Route Matching:
    - Exact path match (case-insensitive)
    - Path parameters use {param} syntax
    - Method must match exactly (GET, POST, PUT, DELETE, PATCH)

    RequiresDataScope:
    - If "true", downstream query handlers should resolve data scope
      via IDataScopeService (business module) for filtering
    - Route security does NOT decide scope level â€” only flags the need
    - Identity module routes typically do NOT require data scope
  -->

  <!-- Public Routes - No authentication required -->
  <PublicRoutes>
    <!-- Authentication endpoints -->
    <Route Method="POST" Path="/api/identity/auth/login" />
    <Route Method="POST" Path="/api/identity/auth/refresh" />
    <Route Method="GET" Path="/api/identity/auth/me" />

    <!-- Health check -->
    <Route Method="GET" Path="/health" />
  </PublicRoutes>

  <!-- Protected Routes - Require authentication and specific permissions -->
  <ProtectedRoutes>

    <!-- ==================== Operator Management ==================== -->

    <!-- List operators (paginated) -->
    <Route
        Method="GET"
        Path="/api/identity/operators"
        Permission="Identity.Operator.View" />

    <!-- Get operator by ID -->
    <Route
        Method="GET"
        Path="/api/identity/operators/{id}"
        Permission="Identity.Operator.View" />

    <!-- Register new operator -->
    <Route
        Method="POST"
        Path="/api/identity/operators/register"
        Permission="Identity.Operator.Create" />

    <!-- Activate operator -->
    <Route
        Method="POST"
        Path="/api/identity/operators/{id}/activate"
        Permission="Identity.Operator.Update" />

    <!-- Update operator -->
    <Route
        Method="PUT"
        Path="/api/identity/operators/{id}"
        Permission="Identity.Operator.Update" />

    <!-- Delete operator -->
    <Route
        Method="DELETE"
        Path="/api/identity/operators/{id}"
        Permission="Identity.Operator.Delete" />

    <!-- Reset operator password -->
    <Route
        Method="POST"
        Path="/api/identity/operators/{id}/reset-password"
        Permission="Identity.Operator.ResetPassword" />

    <!-- Assign role to operator -->
    <Route
        Method="POST"
        Path="/api/identity/operators/{id}/roles"
        Permission="Identity.Operator.AssignRole" />

    <!-- ==================== Role Management ==================== -->

    <!-- List roles -->
    <Route
        Method="GET"
        Path="/api/identity/roles"
        Permission="Identity.Role.View" />

    <!-- Get role by ID -->
    <Route
        Method="GET"
        Path="/api/identity/roles/{id}"
        Permission="Identity.Role.View" />

    <!-- Create role -->
    <Route
        Method="POST"
        Path="/api/identity/roles"
        Permission="Identity.Role.Create" />

    <!-- Update role -->
    <Route
        Method="PUT"
        Path="/api/identity/roles/{id}"
        Permission="Identity.Role.Update" />

    <!-- Delete role -->
    <Route
        Method="DELETE"
        Path="/api/identity/roles/{id}"
        Permission="Identity.Role.Delete" />

    <!-- Assign permissions to role -->
    <Route
        Method="POST"
        Path="/api/identity/roles/{id}/permissions"
        Permission="Identity.Role.AssignPermission" />

    <!-- ==================== Session Management ==================== -->

    <!-- Get active sessions (user can view own sessions) -->
    <Route
        Method="GET"
        Path="/api/identity/sessions"
        Permission="Identity.User.View" />

    <!-- Revoke session -->
    <Route
        Method="DELETE"
        Path="/api/identity/sessions/{id}"
        Permission="Identity.User.Update" />

    <!-- Logout (revoke current session) -->
    <Route
        Method="POST"
        Path="/api/identity/auth/logout"
        Permission="Identity.User.Update" />

  </ProtectedRoutes>

</RouteSecurityMap>
