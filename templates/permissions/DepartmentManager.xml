<?xml version="1.0" encoding="UTF-8"?>
<PermissionTemplate xmlns="http://hrm.system/permissions">
  <Metadata>
    <Name>DepartmentManager</Name>
    <DisplayName>Trưởng phòng</DisplayName>
    <Description>Template dành cho trưởng phòng ban, có quyền quản lý nhân viên và hoạt động trong phòng ban</Description>
    <Version>1.0</Version>
    <ApplicableTo>User</ApplicableTo>
    <Category>Management</Category>
    <IsSystem>true</IsSystem>
  </Metadata>

  <Permissions>
    <!-- Personnel Module -->
    <Module name="Personnel" displayName="Quản lý nhân sự">

      <!-- Employee Entity -->
      <Entity name="Employee" displayName="Nhân viên">

        <!-- View department employees -->
        <Action name="View" displayName="Xem thông tin nhân viên" defaultScope="Department">
          <Scopes>
            <Scope value="Department" displayName="Cùng phòng ban" />
            <Scope value="Position" displayName="Cùng chức danh" readOnly="true" />
            <Scope value="Self" displayName="Chỉ bản thân" />
          </Scopes>
          <Constraints>
            <Constraint type="FieldRestriction">
              <Parameters>
                <!-- Cannot view detailed salary breakdown, only total -->
                <Parameter name="Fields" value="Bonus,Allowances,Deductions" />
                <Parameter name="ApplyTo" value="View" />
              </Parameters>
            </Constraint>
          </Constraints>
        </Action>

        <!-- Update subordinate information (limited) -->
        <Action name="Update" displayName="Cập nhật thông tin nhân viên">
          <Scopes>
            <Scope value="Department" displayName="Cùng phòng ban" />
          </Scopes>
          <Constraints>
            <!-- Must be manager of target employee -->
            <Constraint type="ManagerOfTarget">
              <Parameters>
                <Parameter name="AllowIndirect" value="false" />
                <Parameter name="MaxLevels" value="1" />
              </Parameters>
            </Constraint>
            <!-- Cannot update salary and official records -->
            <Constraint type="FieldRestriction">
              <Parameters>
                <Parameter name="Fields" value="Salary,Bonus,EmployeeCode,HireDate,Department" />
                <Parameter name="ApplyTo" value="Update" />
              </Parameters>
            </Constraint>
          </Constraints>
        </Action>

      </Entity>

      <!-- Department Entity -->
      <Entity name="Department" displayName="Phòng ban">
        <Action name="View" displayName="Xem phòng ban">
          <Scopes>
            <Scope value="Department" displayName="Phòng ban mình" />
          </Scopes>
        </Action>

        <Action name="Update" displayName="Cập nhật phòng ban">
          <Scopes>
            <Scope value="Department" displayName="Phòng ban mình" />
          </Scopes>
          <Constraints>
            <Constraint type="FieldRestriction">
              <Parameters>
                <!-- Can only update description, not structure -->
                <Parameter name="Fields" value="Code,ParentDepartmentId,ManagerId" />
                <Parameter name="ApplyTo" value="Update" />
              </Parameters>
            </Constraint>
          </Constraints>
        </Action>
      </Entity>

      <!-- Position Entity -->
      <Entity name="Position" displayName="Chức danh">
        <Action name="View" displayName="Xem chức danh">
          <Scopes>
            <Scope value="Department" displayName="Cùng phòng ban" />
          </Scopes>
        </Action>
      </Entity>

    </Module>

    <!-- Attendance Module -->
    <Module name="Attendance" displayName="Chấm công">

      <Entity name="Timesheet" displayName="Bảng chấm công">
        <!-- View team timesheets -->
        <Action name="View" displayName="Xem bảng chấm công">
          <Scopes>
            <Scope value="Department" displayName="Cùng phòng ban" />
            <Scope value="Self" displayName="Chỉ bản thân" />
          </Scopes>
        </Action>

        <!-- Approve subordinate timesheets -->
        <Action name="Approve" displayName="Phê duyệt bảng chấm công">
          <Scopes>
            <Scope value="Department" displayName="Cùng phòng ban" />
          </Scopes>
          <Constraints>
            <Constraint type="ManagerOfTarget">
              <Parameters>
                <Parameter name="AllowIndirect" value="false" />
                <Parameter name="MaxLevels" value="1" />
              </Parameters>
            </Constraint>
            <Constraint type="WorkflowState">
              <Parameters>
                <Parameter name="AllowedStates" value="Submitted,Pending" />
              </Parameters>
            </Constraint>
          </Constraints>
        </Action>
      </Entity>

      <Entity name="LeaveRequest" displayName="Đơn xin nghỉ">
        <!-- View team leave requests -->
        <Action name="View" displayName="Xem đơn nghỉ">
          <Scopes>
            <Scope value="Department" displayName="Cùng phòng ban" />
            <Scope value="Self" displayName="Chỉ bản thân" />
          </Scopes>
        </Action>

        <!-- Create own leave request -->
        <Action name="Create" displayName="Tạo đơn nghỉ">
          <Scopes>
            <Scope value="Self" displayName="Chỉ bản thân" />
          </Scopes>
        </Action>

        <!-- Approve subordinate leave requests -->
        <Action name="Approve" displayName="Phê duyệt đơn nghỉ">
          <Scopes>
            <Scope value="Department" displayName="Cùng phòng ban" />
          </Scopes>
          <Constraints>
            <Constraint type="ManagerOfTarget">
              <Parameters>
                <Parameter name="AllowIndirect" value="false" />
                <Parameter name="MaxLevels" value="1" />
              </Parameters>
            </Constraint>
            <Constraint type="WorkflowState">
              <Parameters>
                <Parameter name="AllowedStates" value="Submitted,Pending" />
              </Parameters>
            </Constraint>
          </Constraints>
        </Action>

        <!-- Reject subordinate leave requests -->
        <Action name="Reject" displayName="Từ chối đơn nghỉ">
          <Scopes>
            <Scope value="Department" displayName="Cùng phòng ban" />
          </Scopes>
          <Constraints>
            <Constraint type="ManagerOfTarget">
              <Parameters>
                <Parameter name="AllowIndirect" value="false" />
                <Parameter name="MaxLevels" value="1" />
              </Parameters>
            </Constraint>
            <Constraint type="WorkflowState">
              <Parameters>
                <Parameter name="AllowedStates" value="Submitted,Pending" />
              </Parameters>
            </Constraint>
          </Constraints>
        </Action>
      </Entity>

    </Module>

  </Permissions>
</PermissionTemplate>
